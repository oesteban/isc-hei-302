<!DOCTYPE html>
<html>
  <head>
    <title>DevOps and Docker | 18.09.2025</title>
    <meta charset="utf-8">
    <meta name="grammarly" content="false">
    <meta name="google" content="notranslate">
    <link rel="stylesheet" type="text/css" href="../../remark/asciinema-player/asciinema-player.css?v=5" />
    <link rel="stylesheet" type="text/css" href="../../remark/hes-so.css?v=5" />
    <link rel="stylesheet" href="../../remark/roulette.css?v=5" />
  </head>
  <body>
<script src="../../remark/asciinema-player/asciinema-player.min.js?v=5"></script>
<script src="https://kit.fontawesome.com/015d4b01de.js" crossorigin="anonymous"></script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      processEscapes: true},
      jax: ["input/TeX","input/MathML","input/AsciiMath","output/CommonHTML"],
      extensions: ["tex2jax.js","mml2jax.js","asciimath2jax.js","MathMenu.js","MathZoom.js","AssistiveMML.js", "[Contrib]/a11y/accessibility-menu.js"],
      TeX: {
      extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"],
      equationNumbers: {
      autoNumber: "AMS"
      }
    }
  });
</script>


<textarea id="source">
name: title
layout: true
class: cover

---
count: false
counter: false

.section-mark.center[
<a href="https://oesteban.github.io/isc-hei-302/week1/day2/index.html">
  <object type="image/svg+xml" data="images/qr-talk-url.svg" style="width: 20%"></object>
  <br />
  https://oesteban.github.io/isc-hei-302/week1/day2/index.html
</a>

<br />
<br />

## DevOps and Docker

Oscar Esteban &lt;<code>oscar.esteban@hevs.ch</code>>

<br />

### 302 Data computation (week 1, day 2) — 18.09.2025
]

???

---
name: newsection
layout: true

.perma-sidebar[
<p class="rotate">
<a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0; height: 20px; padding-top: 6px;" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
  <span style="padding-left: 10px; font-weight: 600;">DevOps and Docker (18.09.2025)</span>
</p>
]

---

# Objectives

.boxed-content.no-bullet[
* .larger[<i class="fa-solid fa-circle-right"></i> Solve problems with  **containers**]
  <br /> .indent[.gray-text[and describe the differences with virtual machines]]
  <br />
* .larger[<i class="fa-solid fa-circle-right"></i> Explain the *Docker* **containers** and **images**]
  <br /> .indent[.gray-text[including layers, Dockerfile, and registries]]
  <br />
* .larger[<i class="fa-solid fa-circle-right"></i> Build *Docker* **images** and edit the `Dockerfile`]
  <br /> .indent[.gray-text[understanding layer caching and multi-stage builds]]
  <br />
* .larger[<i class="fa-solid fa-circle-right"></i> Execute commands in *Docker* **containers**]
  <br /> .indent[.gray-text[applying volume mounts, networking, and user mapping]]
  <br />
* .larger[<i class="fa-solid fa-circle-right"></i> Use *Docker compose* to orchestrate containers]
  <br /> .indent[.gray-text[and enable invoking ``docker run`` from within a container]]
  <br />
* .larger[<i class="fa-solid fa-circle-right"></i> Establish a functional **Docker environment**.]
  <br /> .indent[.gray-text[Execute processing tasks on a laptop given a Docker environment with a prepared Jupyter notebook.]]
]

---

.boxed-content.program-table[
| Time | Content |
|:--:|:--|
| 8h15 | Quick quiz (**not graded**). |
| 8h35 | **Roulette**: What do you know/want to know about containers? |
| 9h05 | **Intro&challenge**: the first `Dockerfile` |
| 9h35 | .gray-text[Short break] |
| 9h45 | **Intro&challenge**: Docker compose 1 |
| 11h15 | Challenge results. |
| 11h45 | .gray-text[Lunch break] |
| | |
| 12h45 | **Group use-case**: Docker compose 2 |
| 15h20 | Quick quiz (repetition) |
| 15h35 | Discussion of quiz & **outlook** for next session |
| 15h50 | Voluntary time |
| 16h10 | .gray-text[End] |
]

---

.section-mark[
# Quick quiz

.large[20 minutes, not graded]
]

---
class: roulette
time: 60
include_org: true

# Roulette

.boxed-content[
.pull-right.large[
What do you know/want to know about containers?

.no-bullet.gray-text[
* <i class="fa-solid fa-ranking-star"></i> Benefits/strengths/interest

* <i class="fa-solid fa-triangle-exclamation"></i> Problems/caveats/gaps

* <i class="fa-solid fa-circle-question"></i> Questions

* <i class="fa-solid fa-comment"></i> Opinions/remarks/comments/discussion

* <i class="fa-solid fa-code-fork"></i> VMs/containers: when?
]
]

.pull-left[
> <br />
> — Your code doesn't work.
> <br />
> — It works on my machine!
> <br />
> — Then pack that machine and ship it to the client.

.center[
<img alt="It works on my machine!" src="images/when-the-developers.jpg" style="width: 70%"/>
]
]

]

???

Reasons why 'it works [only] on my machine':

* One or more files are missing (meaning, the installation is not reproducible).
* Software versions mismatch (e.g., Python 3.8 vs 3.10, or a dependency).
* Different settings:
  * Environment variables different or not set (e.g., `PATH`, `PYTHONPATH`, etc.).
  * Configuration files
  * Permissions
  * Platform specific settings (e.g., slightly different hardware)


Examples of why:

* Deployment on production
* A new recruit joins the team
* Version control of deployiment settings (`Dockerfile`)


---

# What's Docker?

.boxed-content[
> Docker is a set of [platform as a service](https://en.wikipedia.org/wiki/Platform_as_a_service) (PaaS) products that use [OS-level virtualization](https://en.wikipedia.org/wiki/OS-level_virtualization) to deliver software in packages called [containers](https://en.wikipedia.org/wiki/Container_%28virtualization%29).
> <br />
> <br />
> (...)
> <br />
> <br />
> Docker is a tool that is used to automate the **deployment** of **applications** in lightweight **containers** so that applications can work efficiently in different environments in isolation. 

.align-right.small[
[Wikipedia](https://en.wikipedia.org/wiki/Docker_%28software%29)
]
]
???

---
count:false

# What's Docker?

.boxed-content[
> Docker is a set of [platform as a service](https://en.wikipedia.org/wiki/Platform_as_a_service) (PaaS) products that use [OS-level virtualization](https://en.wikipedia.org/wiki/OS-level_virtualization) to deliver software in packages called [containers](https://en.wikipedia.org/wiki/Container_%28virtualization%29).
> <br />
> <br />
> (...)
> <br />
> <br />
> Docker is a tool that is used to automate the **deployment** of **applications** in lightweight **containers** so that applications can work efficiently in different environments in isolation. 

.align-right.small[
[Wikipedia](https://en.wikipedia.org/wiki/Docker_%28software%29)
]

.large.center[
**Consistently** build, run and ship applications.
]

]
???

This is why companies  

---

# Containers vs. virtual machines

.boxed-content.center[
<img src="https://wac-cdn.atlassian.com/dam/jcr:92adde69-f728-4cfc-8bab-ba391c25ae58/SWTM-2060_Diagram_Containers_VirtualMachines_v03.png" style="width: 100%; padding-top: 20px;"/>

.align-right.small[
Source: [Atlassian](https://www.atlassian.com/microservices/cloud-computing/containers-vs-vms)
]
]

???

* Containers share the host OS kernel, and isolate the application processes from the rest of the system.
* Virtual machines simulate the physical hardware and install a full OS stack with its own kernel.

BOTH run apps on isolated environments.

**Hypervisor**: software layer that leverages hardware (directly—type 1,—or through the OS—type 2)
virtualization to create and run virtual machines.

* VirtualBox (type 2, cross-platform)
* VMware (type 2, cross-platform)
* KVM (type 2, Linux)
* bhyve (type 2, FreeBSD)
* Parallels (type 2, macOS)
* Xen (type 1, Linux)
* VMware ESXi (type 1, server)
* Hyper-V (type 1, Windows)

---
count: false

# Containers vs. virtual machines

.boxed-content.center[
<img src="https://wac-cdn.atlassian.com/dam/jcr:92adde69-f728-4cfc-8bab-ba391c25ae58/SWTM-2060_Diagram_Containers_VirtualMachines_v03.png" style="width: 100%; padding-top: 20px;"/>

.align-right.small[
Source: [Atlassian](https://www.atlassian.com/microservices/cloud-computing/containers-vs-vms)
]

> — It works on my (virtual) machine

]

???

In terms of deployment, unless you ship the whole VM image
(which is large and may not be portable to the new hardware),
we still may hit 'it works on my (virtual) machine'.

Main caveats of VMs vs containers—each VM needs a full OS:
* Heavy (GBs)
* Slow to boot (minutes)
* More resource hungry (RAM, CPU). Eg., 2 VMs with 2GB RAM each on a host with 4GB RAM will likely
  lead to swapping and very poor performance.
* More HPC-friendly (though, Docker is generally not found in HPC settings)

Benefits of VMs vs containers—each VM is fully isolated:
* More secure (stronger isolation)

---

# Containers vs. virtual machines


.pull-left.large[
VMs win at:

* Traditional, legacy, and/or monolithic workloads
* Isolate risky development cycles
* Provision infrastructure (networks, server, data)
* Run a different OS inside another OS.
]

.pull-right.large[
Containers win at:

* Building cloud-native apps.
* Packaging microservices.
* Deploying applications into DevOps and CI/CD.
* Developing and deploying in heterogeneous settings (laptops, on-prem servers, clouds, edge, HPC...)
* Scaling projects (grow/shrink easily)
]

???

---

# "Shipping weight"
.boxed-content.center[
<object type="image/svg+xml" data="images/shipment-weight-0.svg" style="width: 90%; padding-top: 10pt;"></object>
]

???

---
count: false

# "Shipping weight"
.boxed-content.center[
<object type="image/svg+xml" data="images/shipment-weight-1.svg" style="width: 90%; padding-top: 10pt;"></object>
]

???

‘Bare metal’ is a term that refers to a computer or server that runs on physical hardware and does not require assistance from hypervisors, virtual machines, or containerization in order to operate.

---
count: false

# "Shipping weight"
.boxed-content.center[
<object type="image/svg+xml" data="images/shipment-weight-2.svg" style="width: 90%; padding-top: 10pt;"></object>
]

???

---
count: false

# "Shipping weight"
.boxed-content.center[
<object type="image/svg+xml" data="images/shipment-weight-3.svg" style="width: 90%; padding-top: 10pt;"></object>
]

???

---
count: false

# "Shipping weight"
.boxed-content.center[
<object type="image/svg+xml" data="images/shipment-weight-4.svg" style="width: 90%; padding-top: 10pt;"></object>
]

???

---

# Docker images vs. containers

.boxed-content.center[
<img src="https://lh6.googleusercontent.com/H8mhf23JNy-zCPrLaNs_H4h6K1xLRHv-P0JS4_Ad86xSo7En4tLT3POuOJPrcBNXG5lWDy2Y6fdNzRrzoB9SSLxrHhwrdk-qO28__D19NzO01OkkyBdr7YzZo2K_46HidAoUpmxeW2FOF42uOtAg3Pnfe_gcWafYs7xYywgdFeRdK3kV-p7LfIY7Z9h9tg" style="width: 80%" />
]

???

Image = immutable filesystem changes + metadata.

Container = runtime instance of an image.

Whalesay works the same in all your computers.

[Why we need a different container purely for apps - Mark Suttleworth (Canonical)](https://www.youtube.com/watch?v=0z3yusiCOCk&t=550s)

---

# The first Dockerfile (`oesteban/whalesay`)

.boxed-content[
.large[
```dockerfile
FROM alpine
RUN apk add --no-cache perl
COPY cowsay /usr/local/bin/cowsay
COPY docker.cow /usr/local/share/cows/default.cow
ENTRYPOINT ["/usr/local/bin/cowsay"]
```

[`FROM`](https://docs.docker.com/reference/dockerfile/#from) indicates a base image (`alpine`)

[`RUN`](https://docs.docker.com/reference/dockerfile/#run) executes commands in the image being built (`apk add`)

[`COPY`](https://docs.docker.com/reference/dockerfile/#copy) copies files from the build context into the image

[`ENTRYPOINT`](https://docs.docker.com/reference/dockerfile/#entrypoint) configures a container that will be run from the image

]]

???

How this recipe translates into natural language:

> Start with an alpine linux distribution.
> Install perl without caching installation files (to save space)
> Copy the `cowsay` perl script into the image, at `/usr/local/bin/cowsay`
> Copy the `docker.cow` with the cow template in the image, at the right path
> Tell the Docker runtime to execute `/usr/local/bin/cowsay` when it is invoked.

---

# First line: `FROM alpine`

.boxed-content.larger.no-bullet[
* .large[<i class="fa-solid fa-circle-right"></i> Where does that `alpine` in `FROM alpine` come from?]
  <br /> .indent[From the *Docker Hub*: https://hub.docker.com/_/alpine]

.center[<img src="images/dockerhub-alpine.png" style="width: 56%" />]
]

???

Exercise: search for (and pull) interesting images such as ubuntu, or python/node
images.

---

.boxed-content[
<div class="asciicast" id="docker-build" style="padding-top: 25px"></div>
]

???

---

# Layers in `my_whale`

.boxed-content.large[
```Bash
$ docker image history my_whale

IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
afdf7ad851ab   5 days ago     /bin/sh -c #(nop)  ENTRYPOINT "/usr/local/bi…   0B        
<missing>      5 days ago     /bin/sh -c #(nop) COPY file:6a0962740d5a04ca…   369B      
<missing>      5 days ago     /bin/sh -c #(nop) COPY file:9b4a3b07f3dd78e8…   4.13kB    
<missing>      5 days ago     /bin/sh -c apk add --no-cache perl              38.3MB    
<missing>      2 months ago   CMD ["/bin/sh"]                                 0B        buildkit.dockerfile.v0
<missing>      2 months ago   ADD alpine-minirootfs-3.22.1-x86_64.tar.gz /    8.31MB    buildkit.dockerfile.v0
```

.large[Are images and containers the same?]
]

???

---

# Docker containers vs. images

.boxed-content.center[
<img src="https://miro.medium.com/v2/resize:fit:720/format:webp/0*HoxAZTZ2b2C7AM--" style="width: 70%" />
]

---
class: group-roulette
groups: 4
seed: 18.09.2025

<br />

# **Group Challenge**

.boxed-content[
.text-gray.large[
Edit the example to create the coolest *chatty cow*.
]
.larger[
1. Fork the example: https://github.com/oesteban/whalesay/fork

2. Send a pull-request with your group's cow, including a new file `group-N.cow`.
]
]

???

Tip: existing cows: https://github.com/paulkaefer/cowsay-files/tree/main/cows

Bonus: use mounting to change the cow at run time.

---

.section-mark[
# Short break

.large[We reconvene .timer[in 10 minutes].]
]

---

# Docker compose

.boxed-content[
<img src="https://assets.community.aws/a/2rZiFKvUe94JUmTTO2we7sJa4Pi/1_Iz.webp?imgSize=1400x635" style="width: 100%" />
.small[https://builder.aws.com/content/2qi9qQstGnCWguDzgLg1NgP8lBF/file-structure-of-docker-composeyml-file]
]

???


---
class: group-roulette
groups: 4
seed: 18.09.2025

<br />

# **Group Challenge**

.boxed-content[
.large[
**Problem**: Create a chatty cow web service with two containers:

* Must separate the webserver and the cow content
* Communication can be: telnet/tcp/http, ssh, socket
* Bonus: interchangeable cows, multiple response chat, etc.
* Where to start: [Docker Compose Quickguide](https://docs.docker.com/compose/gettingstarted/)
]
]

???

- Draw the main paths (data, code, results) on a whiteboard/notebook
- Play with datalad to get more data
- Expose the jupyter notebook so changes on the notebook are retained in the host
- Play with detaching from the container and reconnecting (remove `--rm and -it`)
- Try to run two containers in parallel (remove `--rm`).
- Get creative and play

---

.section-mark[
# Lunch break

.large[We reconvene in <span class="timer">1 hour</span>.]
]

---

# Group use-case


.boxed-content[
.small[
> Samira, the most valued employee at your company *We build stuff s.a.r.l.*, left one week ago for Meta.
> The CTO tried hard to keep her, but the offer was just too good to reject. <br /><br />
> Now the company is in trouble: the largest client needs splitting Jupyter and AFNI in the Docker image.
> The CTO had discussed this with Samira, and he vaguely remembers a conversation with her... <br />
> — ... that they could easily use *Docker compose* (whatever that means)... <br />
> — ... to *orchestrate* a Jupyter container and different *Docker images* with neuroimaging software... <br /><br />
> The one thing the CTO knows is that **your team has 2h to implement this**.
]

.large[After those 2h, your team will have 7-8 minutes to show progress]
]

---

# Hint

.boxed-content.large[
Proposed project layout:

```Text
compose-neuro/
├─ docker-compose.yml
├─ .env
├─ notebook/
│  └─ Dockerfile  # Extend jupyter/minimal-notebook:python-3.11
├─ project/
│  ├─ data/       # Installation of ds000005
│  ├─ outputs/
│  └─ notebooks/
│     └─ brain_mri_pipeline.ipynb
└─ afni-slim/
   └─ Dockerfile  # Remove unnecessary steps and ship only AFNI
```
]

---
count: false
class: group-roulette
groups: 4
seed: 18.09.2025

.boxed-content[
# Group use-case

.large[
Rebuild the `oesteban/neuropipeline-302` example, separating neuroimaging libraries and the Jupyter notebook.

**Bonus**: Set up a third service with *Apache Airflow* (they provide a starting docker compose file).

]
]

---

.section-mark[
# Quick quiz (repeat)

.large[20 minutes, not graded]
]

---

.section-mark[
# Concluding

.large[Discuss the quiz answers and outlook for next session]
]

---

.section-mark[
# End

.large[
See you next time: 22.09.2025 @ 8h15 (in <span class="timer" data-until="2025-09-22T08:15:00+02:00"></span>)

[<i class="fa-solid fa-circle-left"></i>](../../week1/day1/index.html)
[<i class="fa-solid fa-home"></i>](#1)
[<i class="fa-solid fa-circle-right"></i>](../../week2/day1/index.html)
]
]


</textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
    <script>
      // Use: ![:img Alt text with spaces but not commas, 50%](image.png)
      remark.macros.img = function (altText, width) {
        var url = this;
        return '<img alt="' + altText + '" src="' + url + '" style="width: ' + width + '" />';
      };
      // Use: ![:video](10.5129/10234)
      remark.macros.video = function (width) {
        var url = this;
        return '<video src="' + url + '" width="' + width + '" preload="auto" controls />';
      };
      // Use: ![:doi](10.5129/10234)
      remark.macros.doi = function () {
        var doi = this;
        return '<a href="https://doi.org/' + doi + '">' + doi + '</a>';
      };

      var slideshow = remark.create({
          highlightStyle: 'monokai',
          highlightLanguage: 'remark',
          highlightLines: true,
          countIncrementalSlides: false,
          highlightSpans: true,
          ratio: '16:9'
      });

      // Now retrieve all IDs of asciinema casts
      const allcasts = new Map();

      slideshow.on('afterShowSlide', function (slide) {
        // Slide is the slide being navigated
        var slideNumber = slide.getSlideIndex();
        var element = document.getElementsByClassName("remark-visible")[0].getElementsByClassName('asciicast')
        if (element.length == 0 ) {
          return;
        }

        if (allcasts.has(slideNumber)) {
          allcasts.get(slideNumber).play();
          return;
        }

        var castid = element[0].attributes["id"].value;
        allcasts.set(slideNumber, AsciinemaPlayer.create(
            `images/${castid}.cast`,
            document.getElementById(castid),
            { autoPlay: true, speed: 1.4, idle_time_limit: 8, rows: 24, cols: 100 }
        ));

      });
      slideshow.on('beforeHideSlide', function (slide) {
        // Slide is the slide being navigated
        var slideNumber = slide.getSlideIndex();
        if (allcasts.has(slideNumber)) {
          allcasts.get(slideNumber).pause();
        }
      });
    </script>
    <script>
    (function attachTimers(slideshow) {
      const SEL = 'span.timer';

      // --- tiny parser: "1h 5m 30s", "10 min", "mm:ss", "hh:mm:ss", or bare minutes ---
      function parseSecs(s) {
        s = (s || '').trim().toLowerCase();
        let m;
        if ((m = s.match(/^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/))) return (+m[1])*3600 + (+m[2])*60 + (+m[3]);
        if ((m = s.match(/^([0-5]?\d):([0-5]?\d)$/)))          return (+m[1])*60   + (+m[2]);
        let total = 0, hit = false;
        s.replace(/(\d+(?:\.\d+)?)\s*(h|hr|hrs|hour|hours|m|min|mins|minute|minutes|s|sec|secs|second|seconds)\b/g,
          (_, n, u) => { hit = true; n = parseFloat(n);
            if (/^h/.test(u)) total += Math.round(n*3600);
            else if (/^m(?!s)/.test(u)) total += Math.round(n*60);
            else total += Math.round(n);
          });
        if (hit) return total;
        const bare = parseFloat(s);
        return Number.isFinite(bare) ? Math.round(bare*60) : null; // bare number = minutes
      }
      function fmt(secs) {
        secs = Math.max(0, Math.floor(secs));
        const h = Math.floor(secs/3600), m = Math.floor((secs%3600)/60), s = secs%60;
        return h ? `${h} hr ${m} min` : (m ? `${m} min ${s} sec` : `${s} sec`);
      }

      function start(el, secs) {
        if (el.dataset.timerRunning === '1') return;
        if (!el.dataset.original) el.dataset.original = el.textContent;
        el.dataset.timerRunning = '1';
        el.classList.add('started');
        const end = Date.now() + secs*1000;
        const tick = () => {
          const remain = Math.max(0, Math.floor((end - Date.now())/1000));
          el.textContent = fmt(remain);
          if (remain <= 0) { stop(el); el.classList.add('finished'); if (el.dataset.done) el.textContent = el.dataset.done; }
        };
        el.dataset.timerId = String(setInterval(tick, 500));
        tick();
      }
      function stop(el) { if (el.dataset.timerId) clearInterval(+el.dataset.timerId); delete el.dataset.timerId; delete el.dataset.timerRunning; }
      function reset(el) { stop(el); el.classList.remove('started','finished'); if (el.dataset.original) el.textContent = el.dataset.original; }

      function initIn(root) {
        root.querySelectorAll(SEL).forEach(el => {
          let secs = el.dataset.seconds ? parseInt(el.dataset.seconds,10) : null;
          if (!Number.isFinite(secs) && el.dataset.until) {
            const until = new Date(el.dataset.until); if (!isNaN(+until)) secs = Math.max(0, Math.round((until - Date.now())/1000));
          }
          if (!Number.isFinite(secs)) secs = parseSecs(el.textContent);
          if (Number.isFinite(secs)) start(el, secs);
        });
      }
      function resetIn(root) { root.querySelectorAll(SEL).forEach(reset); }

      const visibleSlideRoots = () =>
        Array.from(document.querySelectorAll('.remark-slide-container.remark-visible .remark-slide-content'));

      slideshow.on('afterShowSlide', () => visibleSlideRoots().forEach(initIn));
      slideshow.on('beforeHideSlide', () => visibleSlideRoots().forEach(resetIn));

      // kick the initially rendered slide
      visibleSlideRoots().forEach(initIn);
    })(slideshow);
    </script>
    <!-- Add the roulette module -->
    <script src="../../remark/roulette.js?v=4"></script>
    <script>
      // Initialize once
      Roulette.init(slideshow);
    </script>
  </body>
</html>
